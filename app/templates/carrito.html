<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Carrito de Compra</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ver_carrito.css') }}">
</head>

<body>
    <!-- Barra de navegación -->
    <header>
        <div class="nav-container">
            <div class="logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://raw.githubusercontent.com/eliam-villegas/nufraicomers/refs/heads/main/imagenes/nufra_logo-removebg-preview.png" alt="Logo" class="logo-img">
                </a>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a href="/productos">Tienda</a></li>
                    <li><a href="/carrito/ver"><i class="icon-cart"></i> Carrito</a></li>
                    <li><a href="/usuario"><i class="icon-user"></i> Usuario</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Contenido principal del carrito -->
    <main>
        <h1>Carrito de Compras</h1>
        <div id="carritoContainer"></div>

        <!-- Subtotal y botón de pago -->
        <div class="subtotal">
            <p><strong>Subtotal:</strong> $<span id="subtotal">0.00</span></p>
            <button onclick="iniciarPago()">Ir a Pagar</button>
        </div>
    </main>

    <script>
        async function mostrarCarrito() {
            const response = await fetch('/api/carrito');
            const data = await response.json();
            renderizarCarrito(data.carrito);
            calcularSubtotal(data.carrito);
        }

        function renderizarCarrito(carrito) {
            const carritoContainer = document.getElementById("carritoContainer");
            carritoContainer.innerHTML = "";

            carrito.forEach(item => {
                const itemDiv = document.createElement("div");
                itemDiv.classList.add("carrito-item");

                const nombre = document.createElement("p");
                nombre.textContent = item.nombre;

                const precio = document.createElement("p");
                precio.textContent = `Precio: $${item.precio}`;

                const cantidad = document.createElement("input");
                cantidad.type = "number";
                cantidad.value = item.cantidad;
                cantidad.min = 1;
                cantidad.max = item.stock;
                cantidad.addEventListener("change", () => actualizarCantidad(item.producto_id, cantidad.value));

                const subtotal = document.createElement("p");
                subtotal.textContent = `Subtotal: $${(item.precio * item.cantidad).toFixed(2)}`;

                const botonEliminar = document.createElement("button");
                botonEliminar.textContent = "Eliminar";
                botonEliminar.onclick = () => eliminarDelCarrito(item.producto_id);

                itemDiv.append(nombre, precio, cantidad, subtotal, botonEliminar);
                carritoContainer.appendChild(itemDiv);
            });
        }

        function calcularSubtotal(carrito) {
            let total = 0;
            carrito.forEach(item => {
                total += item.precio * item.cantidad;
            });
            document.getElementById("subtotal").textContent = total.toFixed(2);
        }

        async function actualizarCantidad(productoId, nuevaCantidad) {
            await fetch('/api/carrito/actualizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ producto_id: productoId, cantidad: parseInt(nuevaCantidad) })
            });
            mostrarCarrito(); // Actualizar el carrito después de cambiar la cantidad
        }

        async function eliminarDelCarrito(productoId) {
            await fetch('/api/carrito/eliminar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ producto_id: productoId })
            });
            mostrarCarrito(); // Actualizar el carrito después de eliminar
        }

        async function iniciarPago() {
            const subtotal = document.getElementById("subtotal").textContent;

            const response = await fetch("/iniciar_pago", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: parseFloat(subtotal) })
            });

            const data = await response.json();
            if (data.url && data.token) {
                // Redirigir a Webpay Plus con el token
                const form = document.createElement("form");
                form.action = data.url;
                form.method = "POST";

                const tokenInput = document.createElement("input");
                tokenInput.name = "token_ws";
                tokenInput.value = data.token;
                form.appendChild(tokenInput);

                document.body.appendChild(form);
                form.submit();
            } else {
                alert("No se pudo iniciar el pago");
            }
        }

        window.onload = mostrarCarrito;
    </script>
</body>
</html>
